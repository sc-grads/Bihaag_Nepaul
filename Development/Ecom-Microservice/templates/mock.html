<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Document</title>
</head>

<body>
	<script>
	// Function to update the cart badge counter
	function updateCartBadge(cartItems) {
		const cartBadge = document.querySelector('.cart-badge');
		if(cartBadge) {
			// Sum up the quantities of all items
			const totalItems = cartItems.reduce((sum, item) => sum + item.quantity, 0);
			cartBadge.textContent = totalItems;
			// Optionally animate the badge
			cartBadge.style.transform = 'scale(1.2)';
			setTimeout(() => {
				cartBadge.style.transform = 'scale(1)';
			}, 200);
		}
	}
	// Updated addToCart function
	async function addToCart(productId) {
		const quantityInput = document.getElementById(`quantity-${productId}`);
		const quantity = parseInt(quantityInput.value);
		logDebug('Adding to cart...', {
			productId,
			quantity
		});
		try {
			const response = await fetch(`/cart/add`, {
				method: 'POST',
				credentials: 'include',
				headers: {
					'Content-Type': 'application/json',
				},
				mode: 'cors',
				body: JSON.stringify({
					product_id: productId,
					quantity
				}),
			});
			if(!response.ok) {
				const errorData = await response.json();
				throw new Error(errorData.detail || `HTTP error! status: ${response.status}`);
			}
			const data = await response.json();
			logDebug('Added to cart successfully', data);
			// Fetch updated cart data and update UI
			await updateCartUI();
			alert('Product added to cart!');
		} catch (error) {
			logDebug('Error adding to cart:', error.message);
			alert(`Failed to add product to cart: ${error.message}`);
		}
	}
	// Updated updateCartUI function
	async function updateCartUI() {
		const cartContainer = document.getElementById('cart-container');
		logDebug('Updating cart UI...');
		try {
			logDebug('Fetching cart data...');
			const response = await fetch(`http://localhost:8003/cart`, {
				method: 'GET',
				credentials: 'include'
			});
			logDebug('Response received', {
				status: response.status,
				statusText: response.statusText,
				headers: Object.fromEntries(response.headers.entries())
			});
			if(!response.ok) {
				let errorMessage;
				try {
					const errorData = await response.json();
					errorMessage = errorData.detail || `HTTP error! status: ${response.status}`;
				} catch (e) {
					errorMessage = `HTTP error! status: ${response.status}`;
				}
				throw new Error(errorMessage);
			}
			const cartData = await response.json();
			logDebug('Cart data received', cartData);
			// Update the cart badge
			updateCartBadge(cartData.items);
			// Fetch product details for each cart item
			const cartItemsWithDetails = await Promise.all(cartData.items.map(async (item) => {
				const productResponse = await fetch(`/products/${item.product_id}`, {
					credentials: 'include'
				});
				const productData = await productResponse.json();
				return {
					...item,
					productDetails: productData
				};
			}));
			// Clear previous cart HTML
			let cartHTML = '<h3>Your Cart</h3>';
			if(cartItemsWithDetails.length === 0) {
				cartHTML += '<p>Your cart is empty</p>';
				updateCartBadge([]); // Update badge to show 0
			} else {
				cartHTML += '<div class="cart-items">';
				cartItemsWithDetails.forEach(item => {
					cartHTML += `
                    <div class="cart-item">
                        <div class="d-flex align-items-center" style="gap: 15px;">
                            <img src="${item.productDetails.image_url}" 
                                alt="${item.productDetails.name}" 
                                style="width: 50px; height: 50px; object-fit: cover; border-radius: 4px;">
                            <div class="d-flex flex-column">
                                <strong>${item.productDetails.name}</strong>
                                <div class="d-flex align-items-center" style="gap: 20px;">
                                    <span>Quantity: ${item.quantity}</span>
                                    <span>Price: ${formatPriceInRands(item.price)}</span>
                                    <button onclick="removeFromCart(${item.id})" 
                                        class="btn btn-danger btn-sm">
                                        Remove
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
				});
				cartHTML += '</div>';
			}
			cartHTML += `
            <div class="cart-total mt-3 border-top pt-3">
                Total: ${formatPriceInRands(cartData.total)}
            </div>
        `;
			// Insert the updated HTML
			cartContainer.innerHTML = cartHTML;
		} catch (error) {
			logDebug('Error updating cart:', {
				message: error.message,
				stack: error.stack
			});
			cartContainer.innerHTML = `<p>Failed to load cart: ${error.message}</p>`;
		}
	}
	// Updated removeFromCart function
	async function removeFromCart(itemId) {
		logDebug('Removing from cart...', {
			itemId
		});
		try {
			const response = await fetch(`/cart/${itemId}`, {
				method: 'DELETE',
				credentials: 'include',
				mode: 'cors',
			});
			if(!response.ok) {
				const errorData = await response.json();
				throw new Error(errorData.detail || `HTTP error! status: ${response.status}`);
			}
			logDebug('Removed from cart successfully');
			await updateCartUI(); // This will also update the badge
		} catch (error) {
			logDebug('Error removing from cart:', error.message);
			alert(`Failed to remove item from cart: ${error.message}`);
		}
	}
	</script>
</body>

</html>