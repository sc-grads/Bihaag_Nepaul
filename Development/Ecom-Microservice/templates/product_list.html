<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Product Catalog</title>
	<!-- Bootstrap CSS -->
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
	<!-- Custom CSS -->
	<style>
	.custom-card {
		border-radius: 15px;
	}

	.cart-item {
		display: flex;
		justify-content: space-between;
		align-items: center;
		padding: 10px;
		border-bottom: 1px solid #eee;
	}

	.cart-total {
		padding: 10px;
		font-weight: bold;
		text-align: right;
	}

	#cart-container {
		padding: 15px;
	}

	.card-img-top {
		height: 200px;
		object-fit: cover;
	}

	.quantity-control {
		display: flex;
		align-items: center;
		margin-bottom: 10px;
	}

	.quantity-control button {
		width: 30px;
		height: 30px;
		padding: 0;
	}

	.quantity-control input {
		width: 50px;
		text-align: center;
		margin: 0 5px;
	}

	#debug-log {
		position: fixed;
		bottom: 0;
		right: 0;
		width: 300px;
		max-height: 200px;
		overflow-y: auto;
		background: rgba(0, 0, 0, 0.8);
		color: white;
		padding: 10px;
		font-family: monospace;
		font-size: 12px;
		z-index: 1000;
		display: none;
	}
	</style>
</head>

<body>
	<div class="container mt-5">
		<div class="card shadow-lg border-0 mb-5 custom-card">
			<div class="card-header bg-primary text-white text-center py-3">
				<h2 class="mb-0">Product Catalog</h2>
			</div>
			<div class="card-body">
				<div class="row mb-4">
					<div class="col-md-6">
						<div class="input-group">
							<span class="input-group-text"><i class="bi bi-search"></i></span>
							<input type="text" class="form-control" id="searchInput" placeholder="Search products...">
							<div id="searchResults" class="mt-2"></div>
						</div>
					</div>
					<div class="col-md-6 text-md-end mt-3 mt-md-0">
						<button onclick="debugCartService()" class="btn btn-warning me-2">Debug Cart</button>
						<a href="/products/new" class="btn btn-success me-2">Add New Product</a>
						<a href="/auth/logout" class="btn btn-outline-danger">Logout</a>
					</div>
				</div>
				<div class="row mb-4">
					<div class="col-md-4">
						<select id="brandFilter" class="form-select" onchange="filterByBrand()">
							<option value="">Select Brand</option>
							<option value="Brand1">Brand 1</option>
							<option value="Brand2">Brand 2</option>
							<!-- Add more brands as needed -->
						</select>
					</div>
					<div class="col-md-4">
						<select id="yearFilter" class="form-select" onchange="filterByYear()">
							<option value="">Select Year</option>
							<option value="2022">2022</option>
							<option value="2023">2023</option>
							<option value="2024">2024</option>
							<!-- Add more years as needed -->
						</select>
					</div>
				</div>
				<div class="row">
					<div class="col-md-4">
						<div id="cart-container" class="card">
							<h3>Your Cart</h3>
							<div class="cart-items">
								<!-- Cart items will be dynamically inserted here -->
							</div>
							<div class="cart-total">
								<!-- Cart total will be dynamically inserted here -->
							</div>
						</div>
					</div>
					<div class="col-md-8">
						<div id="product-container" class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
							<!-- Products will be dynamically inserted here -->
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	<div id="debug-log"></div>
	<!-- Bootstrap JS and dependencies -->
	<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.10.2/dist/umd/popper.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.min.js"></script>
	<!-- Cart and Product Management Scripts -->
	<script>
	// Debug logging
	function logDebug(message, data = null) {
		const debugLog = document.getElementById('debug-log');
		const timestamp = new Date().toISOString().split('T')[1].split('.')[0];
		let logMessage = `${timestamp} - ${message}`;
		if(data) {
			logMessage += `\n${JSON.stringify(data, null, 2)}`;
		}
		debugLog.innerHTML += logMessage + '\n\n';
		debugLog.scrollTop = debugLog.scrollHeight;
		console.log(message, data);
	}
	// Utility function to get current user ID
	function getCurrentUserId() {
		return 2; // Assuming you are using user ID of 2
	}
	// Utility function to format price in Rands
	function formatPriceInRands(price) {
		return `R ${price.toFixed(2)}`;
	}
	// Debug function for adding to cart
	async function addToCart(productId) {
		const quantityInput = document.getElementById(`quantity-${productId}`);
		const quantity = parseInt(quantityInput.value);
		logDebug('Adding to cart...', {
			productId,
			quantity
		});
		try {
			const response = await fetch(`/cart/add`, {
				method: 'POST',
				credentials: 'include', // Include cookies for CORS
				headers: {
					'Content-Type': 'application/json',
				},
				mode: 'cors',
				body: JSON.stringify({
					product_id: productId,
					quantity
				}),
			});
			if(!response.ok) {
				const errorData = await response.json();
				throw new Error(errorData.detail || `HTTP error! status: ${response.status}`);
			}
			const data = await response.json();
			logDebug('Added to cart successfully', data);
			await updateCartUI();
			alert('Product added to cart!');
		} catch (error) {
			logDebug('Error adding to cart:', error.message);
			alert(`Failed to add product to cart: ${error.message}`);
		}
	}
	// Function for removing items from the cart
	async function removeFromCart(itemId) {
		logDebug('Removing from cart...', {
			itemId
		});
		try {
			const response = await fetch(`/cart/${itemId}`, {
				method: 'DELETE',
				credentials: 'include', // Include cookies for CORS
				mode: 'cors',
			});
			if(!response.ok) {
				const errorData = await response.json();
				throw new Error(errorData.detail || `HTTP error! status: ${response.status}`);
			}
			logDebug('Removed from cart successfully');
			await updateCartUI();
		} catch (error) {
			logDebug('Error removing from cart:', error.message);
			alert(`Failed to remove item from cart: ${error.message}`);
		}
	}
	// Function to update the cart UI
	// Function to update the cart UI
	async function updateCartUI() {
		const cartContainer = document.getElementById('cart-container');
		logDebug('Updating cart UI...');
		try {
			logDebug('Fetching cart data...');
			const response = await fetch(`http://localhost:8003/cart`, {
				method: 'GET',
				credentials: 'include' // This ensures cookies are sent with the request
			});
			logDebug('Response received', {
				status: response.status,
				statusText: response.statusText,
				headers: Object.fromEntries(response.headers.entries())
			});
			if(!response.ok) {
				let errorMessage;
				try {
					const errorData = await response.json();
					errorMessage = errorData.detail || `HTTP error! status: ${response.status}`;
				} catch (e) {
					errorMessage = `HTTP error! status: ${response.status}`;
				}
				throw new Error(errorMessage);
			}
			const cartData = await response.json();
			logDebug('Cart data received', cartData);
			// Clear previous cart HTML
			let cartHTML = '<h3>Your Cart</h3>';
			if(cartData.items.length === 0) {
				cartHTML += '<p>Your cart is empty</p>';
			} else {
				cartHTML += '<div class="cart-items">';
				cartData.items.forEach(item => {
					cartHTML += `
                        <div class="cart-item">
                            <span>${item.product_id}</span> <!-- You might want to fetch the product name -->
                            <span>Quantity: ${item.quantity}</span>
                            <span>Price: ${formatPriceInRands(item.price)}</span>
                            <button onclick="removeFromCart(${item.id})" class="btn btn-danger btn-sm">Remove</button>
                        </div>
                    `;
				});
				cartHTML += '</div>';
			}
			cartHTML += `<div class="cart-total">Total: ${formatPriceInRands(cartData.total)}</div>`;
			// Insert the updated HTML
			cartContainer.innerHTML = cartHTML;
		} catch (error) {
			logDebug('Error updating cart:', {
				message: error.message,
				stack: error.stack
			});
			cartContainer.innerHTML = `<p>Failed to load cart: ${error.message}</p>`;
		}
	}
	// Function to adjust product quantity
	function adjustQuantity(productId, change) {
		const input = document.getElementById(`quantity-${productId}`);
		let value = parseInt(input.value) + change;
		if(value < 1) value = 1;
		input.value = value;
	}
	// Function to load products
	async function loadProducts() {
		const container = document.getElementById('product-container');
		logDebug('Loading products...');
		try {
			const response = await fetch('/products/', {
				credentials: 'include', // Include cookies for CORS
				mode: 'cors',
			});
			if(!response.ok) {
				throw new Error(`HTTP error! status: ${response.status}`);
			}
			const products = await response.json();
			logDebug('Products loaded successfully', {
				count: products.length
			});
			container.innerHTML = products.map(product => `
                    <div class="col">
                        <div class="card h-100">
                            <img src="${product.image_url}" class="card-img-top" alt="${product.name}">
                            <div class="card-body">
                                <h5 class="card-title">${product.name}</h5>
                                <p class="card-text">${product.description}</p>
                                <p class="card-text"><strong>${formatPriceInRands(product.price)}</strong></p>
                                <div class="quantity-control">
                                    <button class="btn btn-outline-secondary" onclick="adjustQuantity(${product.id}, -1)">-</button>
                                    <input type="number" id="quantity-${product.id}" value="1" min="1" class="form-control">
                                    <button class="btn btn-outline-secondary" onclick="adjustQuantity(${product.id}, 1)">+</button>
                                </div>
                                <button onclick="addToCart(${product.id})" class="btn btn-primary w-100">Add to Cart</button>
                            </div>
                        </div>
                    </div>
                `).join('');
		} catch (error) {
			logDebug('Error loading products:', error.message);
			container.innerHTML = `<p class="col-12 text-center">Failed to load products: ${error.message}</p>`;
		}
	}
	async function filterByBrand() {
		const brandFilter = document.getElementById('brandFilter').value;
		let url = '/products';
		if(brandFilter) {
			url = `/products/brand/${brandFilter}`;
		}
		const response = await fetch(url);
		const products = await response.json();
		const productContainer = document.getElementById('product-container');
		logDebug('Products filtered by brand', {
			brandFilter,
			products
		});
		productContainer.innerHTML = '';
		products.forEach(product => {
			const productCard = `
            <div class="col mb-4">
                <div class="card custom-card">
                    <img src="${product.image_url}" alt="${product.name}" class="img-fluid img-thumbnail" style="max-width: 150px;">
                    <div class="card-body">
                        <h5 class="card-title">${product.name}</h5>
                        <p class="card-text">Brand: ${product.brand}</p>
                        <p class="card-text">Price: ${formatPriceInRands(product.price)}</p>
                        <p class="card-text">Year: ${new Date(product.time_added).getFullYear()}</p>
                        <div class="quantity-control">
                            <button onclick="document.getElementById('quantity-${product.id}').stepDown()">-</button>
                            <input type="number" id="quantity-${product.id}" value="1" min="1">
                            <button onclick="document.getElementById('quantity-${product.id}').stepUp()">+</button>
                        </div>
                        <button class="btn btn-primary" onclick="addToCart(${product.id})">Add to Cart</button>
                    </div>
                </div>
            </div>
        `;
			productContainer.innerHTML += productCard;
		});
	}
	async function filterByYear() {
		const yearFilter = document.getElementById('yearFilter').value;
		let url = '/products';
		if(yearFilter) {
			url = `/products/year/${yearFilter}`;
		}
		const response = await fetch(url);
		const products = await response.json();
		const productContainer = document.getElementById('product-container');
		logDebug('Products filtered by year', {
			yearFilter,
			products
		});
		productContainer.innerHTML = '';
		products.forEach(product => {
			const productCard = `
            <div class="col mb-4">
                <div class="card custom-card">
                    <img src="${product.image_url}" alt="${product.name}" class="img-fluid img-thumbnail" style="max-width: 150px;">
                    <div class="card-body">
                        <h5 class="card-title">${product.name}</h5>
                        <p class="card-text">Brand: ${product.brand}</p>
                        <p class="card-text">Price: ${formatPriceInRands(product.price)}</p>
                        <p class="card-text">Year: ${new Date(product.time_added).getFullYear()}</p>
                        <div class="quantity-control">
                            <button onclick="document.getElementById('quantity-${product.id}').stepDown()">-</button>
                            <input type="number" id="quantity-${product.id}" value="1" min="1">
                            <button onclick="document.getElementById('quantity-${product.id}').stepUp()">+</button>
                        </div>
                        <button class="btn btn-primary" onclick="addToCart(${product.id})">Add to Cart</button>
                    </div>
                </div>
            </div>
        `;
			productContainer.innerHTML += productCard;
		});
	}
	// Function to set up search functionality
	function setupSearch() {
		const searchInput = document.getElementById('searchInput');
		searchInput.addEventListener('input', function(e) {
			const searchTerm = e.target.value.toLowerCase();
			const productCards = document.querySelectorAll('#product-container .col');
			productCards.forEach(card => {
				const title = card.querySelector('.card-title').textContent.toLowerCase();
				const description = card.querySelector('.card-text').textContent.toLowerCase();
				if(title.includes(searchTerm) || description.includes(searchTerm)) {
					card.style.display = '';
				} else {
					card.style.display = 'none';
				}
			});
		});
	}
	//////////////////////////////////////////SEARCH
	function setupSearch() {
		const searchInput = document.getElementById('searchInput');
		const searchResults = document.getElementById('searchResults');
		let debounceTimer;
		searchInput.addEventListener('input', function(e) {
			clearTimeout(debounceTimer);
			debounceTimer = setTimeout(() => {
				const searchTerm = e.target.value.trim();
				if(searchTerm.length > 2) {
					performSearch(searchTerm);
				} else {
					searchResults.innerHTML = '';
				}
			}, 300);
		});
	}
	// Function to perform the search
	// Function to set up search functionality
	function setupSearch() {
		const searchInput = document.getElementById('searchInput');
		let debounceTimer;
		searchInput.addEventListener('input', function(e) {
			clearTimeout(debounceTimer);
			debounceTimer = setTimeout(() => {
				const searchTerm = e.target.value.trim().toLowerCase();
				filterProducts(searchTerm);
			}, 300);
		});
	}
	// Function to filter products based on search term
	function filterProducts(searchTerm) {
		const productCards = document.querySelectorAll('#product-container .col');
		let visibleProducts = 0;
		productCards.forEach(card => {
			const title = card.querySelector('.card-title').textContent.toLowerCase();
			const description = card.querySelector('.card-text').textContent.toLowerCase();
			if(title.includes(searchTerm) || description.includes(searchTerm)) {
				card.style.display = '';
				visibleProducts++;
			} else {
				card.style.display = 'none';
			}
		});
		// Show a message if no products match the search
		const noResultsMessage = document.getElementById('no-results-message');
		if(visibleProducts === 0) {
			if(!noResultsMessage) {
				const message = document.createElement('p');
				message.id = 'no-results-message';
				message.className = 'col-12 text-center mt-4';
				message.textContent = 'No products found matching your search.';
				document.getElementById('product-container').appendChild(message);
			}
		} else if(noResultsMessage) {
			noResultsMessage.remove();
		}
		logDebug('Filtered products', {
			searchTerm,
			visibleProducts
		});
	}
	/////////////////////////////////////
	// Initialize the page
	document.addEventListener('DOMContentLoaded', function() {
		logDebug('Initializing page...');
		loadProducts();
		updateCartUI();
		setupSearch();
	});
	</script>
</body>

</html>